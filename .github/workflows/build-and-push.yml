name: Brains Build and Push (Multi-Arch)

on:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y buildah fuse-overlayfs iptables podman slirp4netns uidmap xz-utils
          mkdir -p $HOME/.docker

      - name: Cache Nix Store
        id: cache-nix
        uses: actions/cache@v5
        with:
          path: ~/nix-store.dump
          key: ${{ runner.os }}-nix-store-${{ hashFiles('**/flake.lock') }}

      - name: Cache Nix Database
        id: cache-nix-database
        uses: actions/cache@v5
        with:
          path: ~/nix-database.dump
          key: ${{ runner.os }}-nix-database-${{ hashFiles('**/flake.lock') }}

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore Nix Store
        if: steps.cache-nix.outputs.cache-hit == 'true'
        run: |
          which nix-store
          ls -al /nix/var/nix/profiles/default/bin/nix-store
          ls -al /nix/var/nix/profiles/default/bin/nix
          nix-store --restore /tmp/nix-store < ~/nix-store.dump
          sudo rm -fr /nix/store
          sudo mv /tmp/nix-store /nix/store
          nix-store --restore-db < ~/nix-database.dump

      - name: Build
        run: |
          amd64image=$(buildah from docker-archive:$(nix build .#dockerImage.brains.x86_64-linux --print-out-paths))
          arm64image=$(buildah from docker-archive:$(nix build .#dockerImage.brains.aarch64-linux --print-out-paths))

          manifest=$(buildah manifest create ghcr.io/cnuss/brains:${{ github.sha }})
          buildah manifest add ${manifest} containers-storage:$(buildah inspect --format '{{.FromImageID}}' ${amd64image})
          buildah manifest add ${manifest} containers-storage:$(buildah inspect --format '{{.FromImageID}}' ${arm64image})

      - name: Push to registry
        uses: redhat-actions/push-to-registry@v2
        with:
          registry: ghcr.io
          image: cnuss/brains
          tags: ${{ github.sha }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Dump Nix Store Size
        run: |
          nix-store --dump /nix/store > ~/nix-store.dump
          ls -alh ~/nix-store.dump

      - name: Dump Nix Database Size
        run: |
          nix-store --dump-db > ~/nix-database.dump
          ls -alh ~/nix-database.dump
